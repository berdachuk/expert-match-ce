<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>ExpertMatch - Ingest</title>
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<main class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Ingest</h1>

            <div class="alert alert-warning d-none" id="connectionAlert" role="alert"></div>
            <div class="alert alert-success d-none" id="successAlert" role="alert"></div>
            <div class="alert alert-danger d-none" id="errorAlert" role="alert"></div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Current data statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <div class="text-muted small">Employees</div>
                            <div class="fw-bold" id="statsEmployees">—</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-muted small">Work experiences</div>
                            <div class="fw-bold" id="statsWorkExperiences">—</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-muted small">Projects</div>
                            <div class="fw-bold" id="statsProjects">—</div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="text-muted small">Technologies</div>
                            <div class="fw-bold" id="statsTechnologies">—</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Ingest from external database (with embeddings and graph)</h5>
                </div>
                <div class="card-body">
                    <form id="ingestForm">
                        <div class="mb-3">
                            <label class="form-label" for="batchSize">Batch size</label>
                            <input class="form-control" id="batchSize" max="10000" min="1" name="batchSize"
                                   style="max-width: 150px;" type="number" value="1000">
                            <small class="text-muted">Number of records per batch when reading from external database.
                                Default 1000.</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" id="clear" name="clear" type="checkbox" value="true">
                                <label class="form-check-label" for="clear">Clear existing data first</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" disabled id="startButton" type="submit">
                            <span id="startButtonText">Start ingestion</span>
                            <span aria-hidden="true" class="spinner-border spinner-border-sm d-none ms-2"
                                  id="startSpinner" role="status"></span>
                        </button>
                        <small class="text-muted ms-2">Ingests from external database, then generates embeddings and
                            builds graph. This may take several minutes.</small>
                        <button class="btn btn-danger d-none ms-2" id="stopButton" type="button">
                            <span id="stopButtonText">Stop</span>
                        </button>
                        <div class="mt-3 d-none" id="progressSection">
                            <div class="progress" style="height: 25px;">
                                <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="0"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     id="progressBar" role="progressbar" style="width: 0%">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            <div class="mt-2 text-muted small" id="statusText"></div>
                        </div>
                        <div class="mt-3 d-none" id="logsPanel">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-white">Logs</h6>
                                    <button class="btn btn-sm btn-outline-light" id="toggleLogsButton" type="button">
                                        <span id="toggleLogsText">Collapse</span>
                                    </button>
                                </div>
                                <div class="card-body p-0" id="logsContent"
                                     style="max-height: 500px; overflow-y: auto; display: block;">
                                    <div class="list-group list-group-flush" id="traceEntries"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:src="@{/js/main.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const connectionAlert = document.getElementById('connectionAlert');
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        const ingestForm = document.getElementById('ingestForm');
        const startButton = document.getElementById('startButton');
        const startButtonText = document.getElementById('startButtonText');
        const startSpinner = document.getElementById('startSpinner');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusText = document.getElementById('statusText');
        const stopButton = document.getElementById('stopButton');
        const stopButtonText = document.getElementById('stopButtonText');
        const logsPanel = document.getElementById('logsPanel');
        const traceEntries = document.getElementById('traceEntries');
        const logsContent = document.getElementById('logsContent');
        const toggleLogsButton = document.getElementById('toggleLogsButton');
        const toggleLogsIcon = document.getElementById('toggleLogsIcon');
        const toggleLogsText = document.getElementById('toggleLogsText');
        const batchSizeInput = document.getElementById('batchSize');
        const clearCheckbox = document.getElementById('clear');
        let logsExpanded = true;
        let currentJobId = null;
        let pollInterval = null;
        let ingestionEnabled = false;

        function pollProgress() {
            if (!currentJobId) return;
            fetch('/api/v1/ingestion/progress/' + currentJobId, {
                method: 'GET',
                headers: {'Accept': 'application/json'}
            })
                .then(function (r) {
                    if (r.status === 404) throw new Error('Job not found');
                    if (!r.ok) {
                        return r.text().then(function (body) {
                            var msg = 'Failed to get progress (' + r.status + ' ' + (r.statusText || '') + ')';
                            if (body && body.length < 200) msg += ': ' + body;
                            throw new Error(msg);
                        });
                    }
                    return r.json();
                })
                .then(function (data) {
                    if (!data) return;
                    var pct = data.progress != null ? data.progress : 0;
                    if (data.status === 'running' && pct >= 100) pct = 99;
                    progressBar.style.width = pct + '%';
                    progressBar.setAttribute('aria-valuenow', pct);
                    progressText.textContent = pct + '%';
                    statusText.textContent = (data.currentStep || '') + (data.message ? ': ' + data.message : '');
                    if (data.traceEntries && data.traceEntries.length > 0) {
                        updateTraceEntries(data.traceEntries);
                    }
                    if (data.status === 'completed' || data.status === 'error' || data.status === 'cancelled') {
                        if (pollInterval) {
                            clearInterval(pollInterval);
                            pollInterval = null;
                        }
                    }
                })
                .catch(function (err) {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                });
        }

        function loadStatistics() {
            fetch('/api/v1/test-data/stats', {method: 'GET', headers: {'Accept': 'application/json'}})
                .then(function (r) {
                    if (!r.ok) return;
                    return r.json();
                })
                .then(function (data) {
                    if (data) {
                        var el;
                        if ((el = document.getElementById('statsEmployees'))) el.textContent = data.employees != null ? data.employees : '—';
                        if ((el = document.getElementById('statsWorkExperiences'))) el.textContent = data.workExperiences != null ? data.workExperiences : '—';
                        if ((el = document.getElementById('statsProjects'))) el.textContent = data.projects != null ? data.projects : '—';
                        if ((el = document.getElementById('statsTechnologies'))) el.textContent = data.technologies != null ? data.technologies : '—';
                    }
                })
                .catch(function () {
                    var el;
                    if ((el = document.getElementById('statsEmployees'))) el.textContent = '—';
                    if ((el = document.getElementById('statsWorkExperiences'))) el.textContent = '—';
                    if ((el = document.getElementById('statsProjects'))) el.textContent = '—';
                    if ((el = document.getElementById('statsTechnologies'))) el.textContent = '—';
                });
        }

        function verifyConnection() {
            fetch('/api/v1/ingestion/database/verify', {method: 'GET', headers: {'Accept': 'application/json'}})
                .then(function (r) {
                    return r.json();
                })
                .then(function (data) {
                    if (connectionAlert) connectionAlert.classList.add('d-none');
                    if (data.connected === true) {
                        ingestionEnabled = true;
                        if (startButton) startButton.disabled = false;
                        if (connectionAlert) connectionAlert.classList.add('d-none');
                    } else {
                        ingestionEnabled = false;
                        if (startButton) startButton.disabled = true;
                        if (connectionAlert) {
                            connectionAlert.textContent = data.error || 'External database ingestion is not enabled';
                            connectionAlert.classList.remove('alert-info');
                            connectionAlert.classList.add('alert-warning');
                            connectionAlert.classList.remove('d-none');
                        }
                    }
                })
                .catch(function () {
                    ingestionEnabled = false;
                    if (startButton) startButton.disabled = true;
                    if (connectionAlert) {
                        connectionAlert.textContent = 'Could not verify connection. External database ingestion may not be enabled.';
                        connectionAlert.classList.remove('alert-info');
                        connectionAlert.classList.add('alert-warning');
                        connectionAlert.classList.remove('d-none');
                    }
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateTraceEntries(newEntries) {
            if (!traceEntries || !newEntries) return;
            const currentCount = traceEntries.children.length;
            for (let i = currentCount; i < newEntries.length; i++) {
                const entry = newEntries[i];
                const el = document.createElement('div');
                el.className = 'list-group-item';
                let timestamp = '';
                if (entry.timestamp) {
                    try {
                        const date = new Date(entry.timestamp);
                        timestamp = !isNaN(date.getTime()) ? date.toLocaleTimeString() : entry.timestamp;
                    } catch (e) {
                        timestamp = entry.timestamp;
                    }
                }
                const level = entry.level || 'INFO';
                const step = entry.step || '';
                const message = entry.message || '';
                const progress = entry.progress !== undefined && entry.progress !== null ? entry.progress : '';
                let badgeClass = 'bg-secondary';
                if (level === 'SUCCESS') badgeClass = 'bg-success';
                else if (level === 'ERROR') badgeClass = 'bg-danger';
                else if (level === 'WARN') badgeClass = 'bg-warning';
                else if (level === 'INFO') badgeClass = 'bg-info';
                el.innerHTML = '<div class="d-flex justify-content-between align-items-start">' +
                    '<div class="flex-grow-1">' +
                    '<span class="badge ' + badgeClass + ' me-2">' + level + '</span>' +
                    (step ? '<strong>' + escapeHtml(step) + '</strong>' : '') +
                    (message ? ' <span class="ms-2">' + escapeHtml(message) + '</span>' : '') +
                    '</div>' +
                    '<div class="text-end text-muted small ms-3">' +
                    (timestamp ? '<div>' + timestamp + '</div>' : '') +
                    (progress !== '' ? '<div class="fw-bold">' + progress + '%</div>' : '') +
                    '</div></div>';
                traceEntries.appendChild(el);
            }
            if (logsExpanded && logsContent) logsContent.scrollTop = logsContent.scrollHeight;
        }

        if (toggleLogsButton) {
            toggleLogsButton.addEventListener('click', function () {
                logsExpanded = !logsExpanded;
                if (logsExpanded) {
                    if (logsContent) logsContent.style.display = 'block';
                    if (toggleLogsIcon) toggleLogsIcon.textContent = '\u9660';
                    if (toggleLogsText) toggleLogsText.textContent = ' Collapse';
                } else {
                    if (logsContent) logsContent.style.display = 'none';
                    if (toggleLogsIcon) toggleLogsIcon.textContent = '\u25B6';
                    if (toggleLogsText) toggleLogsText.textContent = ' Expand';
                }
            });
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            currentJobId = null;
            if (startButton) startButton.disabled = false;
            if (startButtonText) startButtonText.textContent = 'Start ingestion';
            if (startSpinner) startSpinner.classList.add('d-none');
            if (stopButton) stopButton.classList.add('d-none');
        }

        if (ingestForm) {
            ingestForm.addEventListener('submit', function (e) {
                e.preventDefault();
                if (!ingestionEnabled) return;
                const batchSize = Math.max(1, Math.min(10000, parseInt(batchSizeInput.value, 10) || 1000));
                const clear = clearCheckbox.checked;

                if (successAlert) successAlert.classList.add('d-none');
                if (errorAlert) errorAlert.classList.add('d-none');
                if (startButton) startButton.disabled = true;
                if (startButtonText) startButtonText.textContent = 'Ingesting...';
                if (startSpinner) startSpinner.classList.remove('d-none');
                if (progressSection) progressSection.classList.remove('d-none');
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', 0);
                }
                if (progressText) progressText.textContent = '0%';
                if (statusText) statusText.textContent = 'Starting ingestion...';
                if (logsPanel) logsPanel.classList.remove('d-none');
                if (traceEntries) traceEntries.innerHTML = '';
                logsExpanded = true;
                if (logsContent) logsContent.style.display = 'block';
                if (toggleLogsIcon) toggleLogsIcon.textContent = '\u9660';
                if (toggleLogsText) toggleLogsText.textContent = ' Collapse';
                if (stopButton) stopButton.classList.remove('d-none');

                const url = '/api/v1/ingestion/database/async?batchSize=' + batchSize + '&clear=' + clear;
                fetch(url, {method: 'POST', headers: {'Accept': 'application/json'}})
                    .then(function (response) {
                        if (!response.ok) {
                            return response.json().then(function (data) {
                                throw new Error(data.message || data.error || 'Failed to start');
                            }).catch(function () {
                                throw new Error('Network error');
                            });
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        currentJobId = data.jobId;
                        if (!currentJobId) {
                            throw new Error('No job ID returned');
                        }

                        function doPoll() {
                            fetch('/api/v1/ingestion/progress/' + currentJobId, {
                                method: 'GET',
                                headers: {'Accept': 'application/json'}
                            })
                                .then(function (r) {
                                    if (r.status === 404) throw new Error('Job not found');
                                    if (!r.ok) {
                                        return r.text().then(function (body) {
                                            var msg = 'Failed to get progress (' + r.status + ' ' + (r.statusText || '') + ')';
                                            if (body && body.length < 200) msg += ': ' + body;
                                            throw new Error(msg);
                                        });
                                    }
                                    return r.json();
                                })
                                .then(function (data) {
                                    var pct = data.progress != null ? data.progress : 0;
                                    if (data.status === 'running' && pct >= 100) pct = 99;
                                    if (progressBar) {
                                        progressBar.style.width = pct + '%';
                                        progressBar.setAttribute('aria-valuenow', pct);
                                    }
                                    if (progressText) progressText.textContent = pct + '%';
                                    var statusLine = (data.currentStep || '') + (data.message ? ': ' + data.message : '');
                                    if (statusText) statusText.textContent = statusLine || 'Running...';
                                    if (data.traceEntries && data.traceEntries.length > 0) {
                                        if (logsPanel) logsPanel.classList.remove('d-none');
                                        updateTraceEntries(data.traceEntries);
                                    }
                                    if (data.status === 'completed') {
                                        stopPolling();
                                        if (progressBar) progressBar.style.width = '100%';
                                        if (progressText) progressText.textContent = '100%';
                                        if (statusText) statusText.textContent = 'Ingestion completed successfully';
                                        if (successAlert) {
                                            successAlert.textContent = 'Ingestion from external database completed (data + embeddings + graph).' + (clear ? ' Existing data was cleared.' : '');
                                            successAlert.classList.remove('d-none');
                                        }
                                        if (progressSection) setTimeout(function () {
                                            progressSection.classList.add('d-none');
                                        }, 2000);
                                        loadStatistics();
                                    } else if (data.status === 'error') {
                                        stopPolling();
                                        if (errorAlert) {
                                            errorAlert.textContent = 'Failed: ' + (data.errorMessage || 'Unknown error');
                                            errorAlert.classList.remove('d-none');
                                        }
                                        if (progressSection) progressSection.classList.add('d-none');
                                    } else if (data.status === 'cancelled') {
                                        if (data.traceEntries && data.traceEntries.length > 0) updateTraceEntries(data.traceEntries);
                                        stopPolling();
                                        if (errorAlert) {
                                            errorAlert.textContent = 'Ingestion was cancelled';
                                            errorAlert.classList.remove('d-none');
                                        }
                                        if (progressSection) setTimeout(function () {
                                            progressSection.classList.add('d-none');
                                        }, 2000);
                                    }
                                })
                                .catch(function (err) {
                                    stopPolling();
                                    if (errorAlert) {
                                        errorAlert.textContent = 'Progress error: ' + err.message;
                                        errorAlert.classList.remove('d-none');
                                    }
                                    if (progressSection) progressSection.classList.add('d-none');
                                });
                        }

                        doPoll();
                        pollInterval = setInterval(doPoll, 500);
                    })
                    .catch(function (error) {
                        stopPolling();
                        if (errorAlert) {
                            errorAlert.textContent = 'Failed to start: ' + error.message;
                            errorAlert.classList.remove('d-none');
                        }
                        if (progressSection) progressSection.classList.add('d-none');
                    });
            });
        }

        if (stopButton) {
            stopButton.addEventListener('click', function () {
                if (!currentJobId) return;
                stopButton.disabled = true;
                if (stopButtonText) stopButtonText.textContent = 'Cancelling...';
                fetch('/api/v1/ingestion/cancel/' + currentJobId, {
                    method: 'POST',
                    headers: {'Accept': 'application/json'}
                })
                    .then(function (r) {
                        if (!r.ok) return r.json().then(function (d) {
                            throw new Error(d.message || 'Cancel failed');
                        });
                        return r.json();
                    })
                    .then(function () {
                        if (stopButtonText) stopButtonText.textContent = 'Cancelled';
                    })
                    .catch(function (err) {
                        if (errorAlert) {
                            errorAlert.textContent = 'Cancel failed: ' + err.message;
                            errorAlert.classList.remove('d-none');
                        }
                        stopButton.disabled = false;
                        if (stopButtonText) stopButtonText.textContent = 'Stop';
                    });
            });
        }

        verifyConnection();
        loadStatistics();
    });
</script>
</body>
</html>
